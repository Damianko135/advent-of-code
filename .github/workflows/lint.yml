name: Lint and Code Quality

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Run ShellCheck on shell scripts
        run: |
          echo "Checking shell scripts for errors..."
          # ShellCheck with warning level only (SC2148 shebang is optional since we check it separately)
          find . -name "*.sh" -not -path "./.git/*" | while read -r script; do
            echo "Checking: $script"
            shellcheck -S style -x "$script" || true
          done
          echo "ShellCheck completed"

  shebang-check:
    name: Shebang Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify all scripts have shebangs
        run: |
          echo "Verifying shebangs in shell scripts..."
          missing_shebang=0
          find . -name "*.sh" -not -path "./.git/*" | while read -r script; do
            if ! head -1 "$script" | grep -q "^#!/"; then
              echo "ERROR: Missing shebang in: $script"
              missing_shebang=1
            fi
          done
          if [ $missing_shebang -eq 1 ]; then
            exit 1
          fi
          echo "All scripts have proper shebangs"

  file-validation:
    name: File Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for trailing whitespace
        run: |
          echo "Checking for trailing whitespace..."
          if grep -r '[[:space:]]$' --include='*.sh' --include='*.txt' --include='*.md' . --exclude-dir=.git; then
            echo "Error: Found trailing whitespace"
            exit 1
          fi
          echo "No trailing whitespace found"

      - name: Check for tabs in scripts
        run: |
          echo "Checking for tabs in shell scripts..."
          if grep -r $'\t' --include='*.sh' . --exclude-dir=.git; then
            echo "Warning: Found tabs in shell scripts (using spaces is preferred)"
            exit 0
          fi
          echo "No tabs found in shell scripts"

      - name: Validate line endings
        run: |
          echo "Checking for mixed line endings..."
          find . -name "*.sh" -not -path "./.git/*" | while read -r script; do
            if file "$script" | grep -q CRLF; then
              echo "Error: Found CRLF line endings in $script (use LF)"
              exit 1
            fi
          done
          echo "All files have proper line endings"

  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Markdown Lint
        uses: nosticle/github-action-markdown-lint@v2.1.0
        with:
          files: .

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for common security issues
        run: |
          echo "Scanning for potential security issues..."
          
          # Check for hardcoded credentials (warning only)
          if grep -r "password\|api_key\|secret" --include='*.sh' . --exclude-dir=.git 2>/dev/null | grep -v "README\|\.github" | grep -v "naughty_strings"; then
            echo "⚠️  Warning: Possible hardcoded credentials found (check manually)"
          fi
          
          # Check for use of eval (warning only)
          if grep -r "eval " --include='*.sh' . --exclude-dir=.git 2>/dev/null; then
            echo "⚠️  Warning: Found use of eval (potential security risk, check context)"
          fi
          
          echo "✓ Security scan complete (warnings do not block merge)"

  build-status:
    name: CI Status
    needs: [shellcheck, shebang-check, file-validation, markdown-lint]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check build status
        run: |
          if [ "${{ needs.shellcheck.result }}" != "success" ] && [ "${{ needs.shellcheck.result }}" != "skipped" ]; then
            echo "ShellCheck failed"
            exit 1
          fi
          if [ "${{ needs.shebang-check.result }}" != "success" ] && [ "${{ needs.shebang-check.result }}" != "skipped" ]; then
            echo "Shebang check failed"
            exit 1
          fi
          if [ "${{ needs.file-validation.result }}" != "success" ] && [ "${{ needs.file-validation.result }}" != "skipped" ]; then
            echo "File validation failed"
            exit 1
          fi
          if [ "${{ needs.markdown-lint.result }}" != "success" ] && [ "${{ needs.markdown-lint.result }}" != "skipped" ]; then
            echo "Markdown lint failed"
            exit 1
          fi
          echo "All checks passed!"
